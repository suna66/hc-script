"use strict";var e,t,r=require("fs"),i=require("timers/promises");function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s=n(function(){if(t)return e;function r(e){return"number"==typeof e||(!!/^0x[0-9a-f]+$/i.test(e)||/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(e))}function i(e,t){return"constructor"===t&&"function"==typeof e[t]||"__proto__"===t}return t=1,e=function(e,t){t||(t={});var n={bools:{},strings:{},unknownFn:null};"function"==typeof t.unknown&&(n.unknownFn=t.unknown),"boolean"==typeof t.boolean&&t.boolean?n.allBools=!0:[].concat(t.boolean).filter(Boolean).forEach((function(e){n.bools[e]=!0}));var s={};function a(e){return s[e].some((function(e){return n.bools[e]}))}Object.keys(t.alias||{}).forEach((function(e){s[e]=[].concat(t.alias[e]),s[e].forEach((function(t){s[t]=[e].concat(s[e].filter((function(e){return t!==e})))}))})),[].concat(t.string).filter(Boolean).forEach((function(e){n.strings[e]=!0,s[e]&&[].concat(s[e]).forEach((function(e){n.strings[e]=!0}))}));var o=t.default||{},l={_:[]};function h(e,t,r){for(var s=e,a=0;a<t.length-1;a++){var o=t[a];if(i(s,o))return;void 0===s[o]&&(s[o]={}),s[o]!==Object.prototype&&s[o]!==Number.prototype&&s[o]!==String.prototype||(s[o]={}),s[o]===Array.prototype&&(s[o]=[]),s=s[o]}var l=t[t.length-1];i(s,l)||(s!==Object.prototype&&s!==Number.prototype&&s!==String.prototype||(s={}),s===Array.prototype&&(s=[]),void 0===s[l]||n.bools[l]||"boolean"==typeof s[l]?s[l]=r:Array.isArray(s[l])?s[l].push(r):s[l]=[s[l],r])}function c(e,t,i){if(!i||!n.unknownFn||function(e,t){return n.allBools&&/^--[^=]+$/.test(t)||n.strings[e]||n.bools[e]||s[e]}(e,i)||!1!==n.unknownFn(i)){var a=!n.strings[e]&&r(t)?Number(t):t;h(l,e.split("."),a),(s[e]||[]).forEach((function(e){h(l,e.split("."),a)}))}}Object.keys(n.bools).forEach((function(e){c(e,void 0!==o[e]&&o[e])}));var u=[];-1!==e.indexOf("--")&&(u=e.slice(e.indexOf("--")+1),e=e.slice(0,e.indexOf("--")));for(var v=0;v<e.length;v++){var p,d,f=e[v];if(/^--.+=/.test(f)){var x=f.match(/^--([^=]+)=([\s\S]*)$/);p=x[1];var b=x[2];n.bools[p]&&(b="false"!==b),c(p,b,f)}else if(/^--no-.+/.test(f))c(p=f.match(/^--no-(.+)/)[1],!1,f);else if(/^--.+/.test(f))p=f.match(/^--(.+)/)[1],void 0===(d=e[v+1])||/^(-|--)[^-]/.test(d)||n.bools[p]||n.allBools||s[p]&&a(p)?/^(true|false)$/.test(d)?(c(p,"true"===d,f),v+=1):c(p,!n.strings[p]||"",f):(c(p,d,f),v+=1);else if(/^-[^-]+/.test(f)){for(var m=f.slice(1,-1).split(""),y=!1,g=0;g<m.length;g++)if("-"!==(d=f.slice(g+2))){if(/[A-Za-z]/.test(m[g])&&"="===d[0]){c(m[g],d.slice(1),f),y=!0;break}if(/[A-Za-z]/.test(m[g])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(d)){c(m[g],d,f),y=!0;break}if(m[g+1]&&m[g+1].match(/\W/)){c(m[g],f.slice(g+2),f),y=!0;break}c(m[g],!n.strings[m[g]]||"",f)}else c(m[g],d,f);p=f.slice(-1)[0],y||"-"===p||(!e[v+1]||/^(-|--)[^-]/.test(e[v+1])||n.bools[p]||s[p]&&a(p)?e[v+1]&&/^(true|false)$/.test(e[v+1])?(c(p,"true"===e[v+1],f),v+=1):c(p,!n.strings[p]||"",f):(c(p,e[v+1],f),v+=1))}else if(n.unknownFn&&!1===n.unknownFn(f)||l._.push(n.strings._||!r(f)?f:Number(f)),t.stopEarly){l._.push.apply(l._,e.slice(v+1));break}}return Object.keys(o).forEach((function(e){var t,r,i;t=l,r=e.split("."),i=t,r.slice(0,-1).forEach((function(e){i=i[e]||{}})),r[r.length-1]in i||(h(l,e.split("."),o[e]),(s[e]||[]).forEach((function(t){h(l,t.split("."),o[e])})))})),t["--"]?l["--"]=u.slice():u.forEach((function(e){l._.push(e)})),l}}());class a{constructor(e){this.sentence=e,this.text=void 0,this.line=1,this.token=void 0}next(){for(;;){var e=this.sentence[0];if(null==e)return this.token=null,null;switch(this.sentence=this.sentence.slice(1),e){case" ":case"\r":case"\t":continue;case"\n":return this.line++,this.token=e,e;case"P":if(this.sentence.startsWith("OST"))return this.sentence=this.sentence.slice(3),this.token="POST",this.token;if(this.sentence.startsWith("UT"))return this.sentence=this.sentence.slice(2),this.token="PUT",this.token;if(this.sentence.startsWith("ATCH"))return this.sentence=this.sentence.slice(4),this.token="PATCH",this.token;break;case"G":if(this.sentence.startsWith("ET"))return this.sentence=this.sentence.slice(2),this.token="GET",this.token;break;case"D":if(this.sentence.startsWith("ELETE"))return this.sentence=this.sentence.slice(5),this.token="DELETE",this.token;break;case"i":if(this.sentence.startsWith("f"))return this.sentence=this.sentence.slice(1),this.token="IF",this.token;break;case"w":if(this.sentence.startsWith("hile"))return this.sentence=this.sentence.slice(4),this.token="WHILE",this.token;break;case"e":if(this.sentence.startsWith("nd"))return this.sentence=this.sentence.slice(2),this.token="END",this.token;break;case"s":if(this.sentence.startsWith("leep"))return this.sentence=this.sentence.slice(4),this.token="sleep",this.token;break;case"=":if("="==this.sentence[0])return this.sentence=this.sentence.slice(1),this.token="==",this.token;break;case">":if("="==this.sentence[0])return this.sentence=this.sentence.slice(1),this.token=">=",this.token;break;case"<":if("="==this.sentence[0])return this.sentence=this.sentence.slice(1),this.token="<=",this.token;break;case"!":if("="==this.sentence[0])return this.sentence=this.sentence.slice(1),this.token="!=",this.token;break;case"&":case"|":return this.sentence[0]==e&&(this.sentence=this.sentence.slice(1)),this.token=e,this.token;case'"':for(var t="",r=0;'"'!=(e=this.sentence[r++])&&null!=e&&null!=e;)"\n"==e&&this.line++,t+=e;return this.sentence=this.sentence.slice(r),this.text=t,this.token="string",this.token;case"{":t=e,r=0;for(var i=1;null!=(e=this.sentence[r++])&&null!=e&&("{"==e&&i++,"}"==e&&i--,"\n"==e&&this.line++,t+=e,0!=i););return this.sentence=this.sentence.slice(r),this.text=t,this.token="json",this.token;case"#":for(r=0;;)if("\n"==(e=this.sentence[r++])||null==e||null==e){this.line++;break}this.sentence=this.sentence.slice(r);continue}if(e>="0"&&e<="9"){t=e,r=0;for(var n="int";(e=this.sentence[r++])>="0"&&e<="9"||"."==e;){if("."==e){if("number"==n)return console.error("lex error(%d): %s",this.line,"invalid number"),null;n="number"}t+=e}return this.sentence=this.sentence.slice(r-1),this.text=t,this.token=n,this.token}if(e>="a"&&e<="z"||e>="A"&&e<="Z"||"_"==e){for(t=e,r=0;(e=this.sentence[r++])>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"==e;)t+=e;return this.sentence=this.sentence.slice(r-1),this.text=t,this.token="id",this.token}return this.token=e,e}return null}getLine(){return this.line}getText(){return this.text}getToken(){return this.token}}class o{static log(...e){o.loggerLevel>1||console.log(...e)}static info(...e){o.loggerLevel>1||console.log(...e)}static warn(...e){o.loggerLevel>2||console.warn(...e)}static error(...e){o.loggerLevel>3||console.error(...e)}}o.loggerLevel=0;class l{constructor(){this.lex=void 0}_rootExpression(){var e,t,r,i;let n=this._condConcatExpression();if(null==n)throw o.error("syntax error(top level expression):%d - %o",null===(e=this.lex)||void 0===e?void 0:e.getLine(),null===(t=this.lex)||void 0===t?void 0:t.getText()),new Error("syntax error(top level expression)");let s=this.lex.getToken();if("="==s){this.lex.next();let e=this._rootExpression();if(null==e)throw o.error("syntax error(top level expression):%d - %o",null===(r=this.lex)||void 0===r?void 0:r.getLine(),null===(i=this.lex)||void 0===i?void 0:i.getText()),new Error("syntax error(top level expression)");return{type:s,variable:void 0,value:void 0,left:n,right:e}}return n}_condConcatExpression(){var e,t,r,i;let n=this._compareExpression();if(null==n)throw o.error("syntax error(cond concat expression):%d - %o",null===(e=this.lex)||void 0===e?void 0:e.getLine(),null===(t=this.lex)||void 0===t?void 0:t.getText()),new Error("syntax error(cond concat expression)");let s=this.lex.getToken();if("&"==s||"|"==s){this.lex.next();let e=this._condConcatExpression();if(null==e)throw o.error("syntax error(cond concat expression):%d - %o",null===(r=this.lex)||void 0===r?void 0:r.getLine(),null===(i=this.lex)||void 0===i?void 0:i.getText()),new Error("syntax error(cond concat expression)");return{type:s,variable:void 0,value:void 0,left:n,right:e}}return n}_compareExpression(){var e,t,r,i;let n=this._addSubExpression();if(null==n)throw o.error("syntax error(compare expression):%d - %o",null===(e=this.lex)||void 0===e?void 0:e.getLine(),null===(t=this.lex)||void 0===t?void 0:t.getText()),new Error("syntax error(compare expression)");let s=this.lex.getToken();if(">="==s||"<="==s||"=="==s||"!="==s||">"==s||"<"==s){this.lex.next();let e=this._compareExpression();if(null==e)throw o.error("syntax error(compare expression):%d - %o",null===(r=this.lex)||void 0===r?void 0:r.getLine(),null===(i=this.lex)||void 0===i?void 0:i.getText()),new Error("syntax error(compare expression)");return{type:s,variable:void 0,value:void 0,left:n,right:e}}return n}_addSubExpression(){var e,t,r,i,n,s;let a=this._mulDivExpression();if(null==a)throw o.error("syntax error(add/sub expression) %d - %o",null===(e=this.lex)||void 0===e?void 0:e.getLine(),null===(t=this.lex)||void 0===t?void 0:t.getText()),new Error("syntax error(add/sub expression)");let l=null===(r=this.lex)||void 0===r?void 0:r.getToken();if("+"==l||"-"==l){null===(i=this.lex)||void 0===i||i.next();let e=this._addSubExpression();if(null==e)throw o.error("syntax error(add/sub expression) %d - %o",null===(n=this.lex)||void 0===n?void 0:n.getLine(),null===(s=this.lex)||void 0===s?void 0:s.getText()),new Error("syntax error(add/sub expression)");return{type:l,variable:void 0,value:void 0,left:a,right:e}}return a}_mulDivExpression(){var e,t,r,i,n,s;let a=this._factor();if(null==a)throw o.error("syntax error(mul/div expression) %d - %o",null===(e=this.lex)||void 0===e?void 0:e.getLine(),null===(t=this.lex)||void 0===t?void 0:t.getText()),new Error("syntax error(mul/div expression)");let l=null===(r=this.lex)||void 0===r?void 0:r.getToken();if("*"==l||"/"==l){null===(i=this.lex)||void 0===i||i.next();let e=this._mulDivExpression();if(null==e)throw o.error("syntax error(mul/div expression) %d - %o",null===(n=this.lex)||void 0===n?void 0:n.getLine(),null===(s=this.lex)||void 0===s?void 0:s.getText()),new Error("syntax error(mul/div expression)");return{type:l,variable:void 0,value:void 0,left:a,right:e}}return a}_factor(){var e;let t=null===(e=this.lex)||void 0===e?void 0:e.getToken();if("-"==t){this.lex.next();let e=this._term();if(null==e)throw o.error("syntax error(illegal position of operation symbol) %s - %o",this.lex.getLine(),t),new Error("syntax error(illegal position of operation symbol)");return{type:"*",variable:void 0,value:void 0,right:e,left:{type:"number",value:-1,variable:void 0,left:void 0,right:void 0}}}if("("==t){this.lex.next();const e=this._rootExpression();if(t=this.lex.getToken(),null==e||")"!=t)throw o.error("syntax error(illegal position of operation symbol) %s - %o",this.lex.getLine(),t),new Error("syntax error(illegal position of operation symbol)");return this.lex.next(),e}if("!"==t){this.lex.next();let e=this._rootExpression();if(null==e)throw o.error("syntax error(illegal position of operation symbol) %s - %o",this.lex.getLine(),t),new Error("syntax error(illegal position of operation symbol)");return{type:"!",variable:void 0,value:void 0,right:e,left:void 0}}return this._term()}_term(){var e,t,r,i,n;let s=null===(e=this.lex)||void 0===e?void 0:e.getToken();if("string"==s||"number"==s||"int"==s||"json"==s){const e=this._literal();if(null==e)throw o.error("syntax error(unknown literal value) %d - %o",null===(t=this.lex)||void 0===t?void 0:t.getLine(),null===(r=this.lex)||void 0===r?void 0:r.getText()),new Error("syntax error(unknown literal value)");return e}if("id"==s){return this._ident()}throw o.error("syntax error(not found variables or literals) %d - %o",null===(i=this.lex)||void 0===i?void 0:i.getLine(),null===(n=this.lex)||void 0===n?void 0:n.getText()),new Error("syntax error(not found variables or literals)")}_ident(){var e,t,r,i,n,s,a;let l=null===(e=this.lex)||void 0===e?void 0:e.getText();var h={name:l,member:void 0},c={type:"var",variable:h,value:void 0,left:void 0,right:void 0};let u=null===(t=this.lex)||void 0===t?void 0:t.next();for(;"."==u;){if(u=null===(r=this.lex)||void 0===r?void 0:r.next(),"id"!=u)throw o.error("syntax error(unknown token) %d - %o",null===(n=this.lex)||void 0===n?void 0:n.getLine(),null===(s=this.lex)||void 0===s?void 0:s.getText()),new Error("syntax error(unknown token)");l=null===(i=this.lex)||void 0===i?void 0:i.getText();var v={name:l,member:void 0};h.member=v,h=v,u=null===(a=this.lex)||void 0===a?void 0:a.next()}return c}_literal(){var e,t,r;let i=null===(e=this.lex)||void 0===e?void 0:e.getToken(),n=null===(t=this.lex)||void 0===t?void 0:t.getText();if(null===(r=this.lex)||void 0===r||r.next(),"number"==i){return{type:"number",value:parseFloat(n),variable:void 0,left:void 0,right:void 0}}if("int"==i){return{type:"number",value:parseInt(n),variable:void 0,left:void 0,right:void 0}}if("string"==i){return{type:"string",value:n,variable:void 0,left:void 0,right:void 0}}if("json"==i){return{type:"json",value:n,variable:void 0,left:void 0,right:void 0}}}_identStatement(e){let t=this._rootExpression();if(null==t)throw o.error("syntax error(illigale ident statement) %d - %s",this.lex.getLine(),this.lex.getToken()),new Error("syntax error(illigale ident statement)");e.push(t)}_httpStatement(e){const t=this.lex.getToken();var r=this.lex.next();if("string"!=r)throw o.error("syntax error(no URL) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(no URL)");const i=this.lex.getText();if("\n"!=(r=this.lex.next()))throw o.error("syntax error(illegal http expression) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(illegal http expression)");const n={type:"http",method:t,url:i,headers:[],parameters:[],body:void 0,bind:void 0};for(r=this.lex.next();"\n"!=r&&null!=r;){if("string"!=r)throw o.error("syntax error(parameter key error) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(parameter key error)");const e=this.lex.getText().toUpperCase();if(":"!=(r=this.lex.next())&&"="!=r||(r=this.lex.next()),"string"!=r&&"json"!=r&&"id"!=r)throw o.error("syntax error(parameter value error) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(parameter value error)");const t=this.lex.getText();if("PARAMETER"!=e&&"BODY"!=e&&"BIND"!=e){const r={key:e,value:t};n.headers.push(r)}else if("PARAMETER"==e){if("string"!=r)throw o.error("syntax error(request parameter is not string) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(request parameter is not string)");n.parameters.push(t)}else if("BODY"==e){const e={type:r,value:t};n.body=e}else if("BIND"==e){if("id"!=r)throw o.error("syntax error(bind parameter is not variable) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(bind parameter is not variable)");n.bind=t}if("\n"!=(r=this.lex.next()))throw o.error("syntax error(no end of line) %d - %o",this.lex.getLine(),this.lex.getText()),new Error("syntax error(no end of line)");r=this.lex.next()}e.push(n),this.lex.next()}_controlStatement(e){let t=this.lex.getToken();if("IF"!=t&&"WHILE"!=t)return;const r={type:"",cond:void 0,syntaxList:[]};if(this.lex.next(),"IF"==t){r.type="if";let t=this._rootExpression();r.cond=t,e.push(r)}else if("WHILE"==t){r.type="while";let t=this._rootExpression();r.cond=t,e.push(r)}if(t=this.lex.getToken(),"\n"!=t)throw o.error("syntax error(no end of line) %d - %o",this.lex.getLine(),t),new Error("syntax error(no end of line)");this.lex.next();let i=[];this._parse(i),r.syntaxList=i}_sleepStatement(e){let t=this.lex.getToken();if("sleep"!=t)return;const r={type:"sleep",cond:void 0,syntaxList:void 0};this.lex.next();let i=this._rootExpression();if(r.cond=i,t=this.lex.getToken(),"\n"!=t)throw o.error("syntax error(no end of line) %d - %o",this.lex.getLine(),t),new Error("syntax error(no end of line)");this.lex.next(),e.push(r)}_stdioutStatement(e){var t;if("string"==this.lex.getToken()){const t={type:"output",value:this.lex.getText()};e.push(t)}null===(t=this.lex)||void 0===t||t.next()}_parse(e){for(;;){const t=this.lex.getToken();if(null==t)break;if("\n"!=t)switch(t){case"id":this._identStatement(e);break;case"GET":case"POST":case"PUT":case"PATCH":case"DELETE":this._httpStatement(e);break;case"IF":case"WHILE":this._controlStatement(e);break;case"END":return void this.lex.next();case"sleep":this._sleepStatement(e);break;default:this._stdioutStatement(e)}else this.lex.next()}}parse(e){this.lex=new a(e);var t=[];return this.lex.next(),this._parse(t),t}}class h{constructor(e){this.variables={},this.stack=[],this.cmdlineParam=void 0,this.step=!1,this.variables={},this.stack=[],this.cmdlineParam=e,this.step=!1}setStep(e){this.step=e}_getVariableValue(e){let t=e.name,r=this.variables[t];if(null==r)return;if("json"!=r.type)return r;let i={type:r.type,value:r.value},n=r.value;for(;null!=e.member;)n=n[(e=e.member).name];return"object"==typeof n?(i.type="json",i.value=n):(i.type=typeof n,i.value=n),i}_getValueFromVariablePath(e){let t=e.split("."),r=this.variables[t[0]];if(null==r)return;if("json"!=r.type)return r;let i={type:r.type,value:r.value},n=r.value;for(let e=1;e<t.length;e++)n=n[t[e]];return"object"==typeof n?(i.type="json",i.value=n):(i.type=typeof n,i.value=n),i}_hasVariableInStr(e){for(var t=0;t<e.length;t++)if("$"==e[t]&&"{"==e[t+1])return!0;return!1}_convertVariableInStr(e){var t="",r=0;if(!this._hasVariableInStr(e))return e;for(;;){var i=e[r++];if(null==i)break;if("$"==i&&"{"==e[r]){r++;for(var n="";null!=(i=e[r++])&&"}"!=i;)n+=i;if(n.length>0){var s=void 0;if(isNaN(parseInt(n)))s=this._getValueFromVariablePath(n);else{const e=parseInt(n);null!=this.cmdlineParam&&this.cmdlineParam.length<e&&(s=this.cmdlineParam[e])}i=null!=s?"json"==s.type?JSON.stringify(s.value,null,2):s.value:""}}t+=i}return t}_strToJson(e){return JSON.parse(e)}_checkArithmeticObj(e,t){if(null==e)return!1;if("json"==e.type)return!1;if(!t&&"string"==e.type)return!1;if("var"==e.type){if(null==e.variable)return!1;let r=this._getVariableValue(e.variable);if(null==r)return!1;if("json"==r.type)return!1;if(!t&&"string"==r.type)return!1;if(null==r.value)return!1}return!0}_addExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!0)||!this._checkArithmeticObj(t,!0))throw o.error("semantic error. can't add undefined."),new Error("semantic error. can't add undefined.");var r=e.value,i=t.value;"var"==e.type&&e.variable&&(r=this._getVariableValue(e.variable)),"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable));var n=i.value+r.value;const s={type:typeof n,value:n};this.stack.push({type:s.type,value:s,variable:void 0})}_subExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!1)||!this._checkArithmeticObj(t,!1))throw o.error("semantic error. can't sub undefined."),new Error("semantic error. can't sub undefined.");var r=e.value,i=t.value;"var"==e.type&&e.variable&&(r=this._getVariableValue(e.variable)),"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable));var n=i.value-r.value;const s={type:typeof n,value:n};this.stack.push({type:s.type,value:s,variable:void 0})}_mulExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!1)||!this._checkArithmeticObj(t,!1))throw o.error("semantic error. can't mul undefined."),new Error("semantic error. can't mul undefined.");var r=e.value,i=t.value;"var"==e.type&&e.variable&&(r=this._getVariableValue(e.variable)),"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable));var n=i.value*r.value;const s={type:typeof n,value:n};this.stack.push({type:s.type,value:s,variable:void 0})}_divExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!1)||!this._checkArithmeticObj(t,!1))throw o.error("semantic error. can't div undefined."),new Error("semantic error. can't div undefined.");var r=e.value,i=t.value;if("var"==e.type&&e.variable&&(r=this._getVariableValue(e.variable)),"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable)),0==r.value)throw o.error("can't divide by 0"),new Error("can't divide by 0");var n=i.value/r.value;const s={type:typeof n,value:n};this.stack.push({type:s.type,value:s,variable:void 0})}_largerThenExecute(e){var t=this.stack.pop(),r=this.stack.pop();if(!this._checkArithmeticObj(t,!0)||!this._checkArithmeticObj(r,!0))throw o.error("semantic error. can't comparison undefined."),new Error("semantic error. can't comparison undefined.");var i=t.value,n=r.value;"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable)),"var"==r.type&&r.variable&&(n=this._getVariableValue(r.variable));const s={type:"number",value:(e?n.value>=i.value:n.value>i.value)?1:0};this.stack.push({type:s.type,value:s,variable:void 0})}_smallerThenExecute(e){var t=this.stack.pop(),r=this.stack.pop();if(!this._checkArithmeticObj(t,!0)||!this._checkArithmeticObj(r,!0))throw o.error("semantic error. can't comparison undefined."),new Error("semantic error. can't comparison undefined.");var i=t.value,n=r.value;"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable)),"var"==r.type&&r.variable&&(n=this._getVariableValue(r.variable));const s={type:"number",value:(e?n.value<=i.value:n.value<i.value)?1:0};this.stack.push({type:s.type,value:s,variable:void 0})}_equalExecute(e){var t=this.stack.pop(),r=this.stack.pop();if(!this._checkArithmeticObj(t,!0)||!this._checkArithmeticObj(r,!0))throw o.error("semantic error. can't comparison undefined."),new Error("semantic error. can't comparison undefined.");var i=t.value,n=r.value;"var"==t.type&&t.variable&&(i=this._getVariableValue(t.variable)),"var"==r.type&&r.variable&&(n=this._getVariableValue(r.variable));const s={type:"number",value:(e?n.value!=i.value:n.value==i.value)?1:0};this.stack.push({type:s.type,value:s,variable:void 0})}_andExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!1)||!this._checkArithmeticObj(t,!1))throw o.error("semantic error. can't AND comparison undefined."),new Error("semantic error. can't AND comparison undefined.");var r=e.value,i=t.value;if("number"!=r.type||"number"!=i.type)throw o.error("semantic error. can't AND comparison no number value"),new Error("semantic error. can't AND comparison no number value");let n=0!=r.value,s=0!=i.value;const a={type:"number",value:n&&s?1:0};this.stack.push({type:a.type,value:a,variable:void 0})}_orExecute(){var e=this.stack.pop(),t=this.stack.pop();if(!this._checkArithmeticObj(e,!1)||!this._checkArithmeticObj(t,!1))throw o.error("semantic error. can't OR comparison undefined."),new Error("semantic error. can't OR comparison undefined.");var r=e.value,i=t.value;if("number"!=r.type||"number"!=i.type)throw o.error("semantic error. can't OR comparison no number value"),new Error("semantic error. can't OR comparison no number value");let n=0!=r.value,s=0!=i.value;const a={type:"number",value:n||s?1:0};this.stack.push({type:a.type,value:a,variable:void 0})}_notExpression(){var e=this.stack.pop();if(!this._checkArithmeticObj(e,!1))throw o.error("semantic error. can't NOT comparison undefined."),new Error("semantic error. can't NOT comparison undefined.");var t=e.value;if("number"!=t.type)throw o.error("semantic error. can't NOT comparison undefined."),new Error("semantic error. can't NOT comparison undefined.");t.value=0!=t.value?0:1,this.stack.push(e)}_assignExecute(){var e=this.stack.pop(),t=this.stack.pop();if("var"!=t.type)throw o.error("can't assgin value to no variable"),new Error("can't assgin value to no variable");var r=e.value;"var"==e.type&&(r=this.variables[e.variable.name]);var i=t.variable,n=this.variables[i.name];if(null==n||null==i.member)this.variables[i.name]=r;else for(n=n.value;null!=i.member;){if(null==n[i.member.name]&&(n[i.member.name]={}),null==i.member.member){n[i.member.name]=r.value;break}"object"!=typeof n[i.member.name]&&(n[i.member.name]={}),n=n[i.member.name],i=i.member}this.stack.length>0&&this.stack.push(e)}_semantic(e){var t;switch(e.type){case"+":case"&":this._semantic(e.left),this._semantic(e.right),this._addExecute();break;case"-":this._semantic(e.left),this._semantic(e.right),this._subExecute();break;case"*":this._semantic(e.left),this._semantic(e.right),this._mulExecute();break;case"/":this._semantic(e.left),this._semantic(e.right),this._divExecute();break;case">":this._semantic(e.left),this._semantic(e.right),this._largerThenExecute(!1);break;case">=":this._semantic(e.left),this._semantic(e.right),this._largerThenExecute(!0);break;case"<":this._semantic(e.left),this._semantic(e.right),this._smallerThenExecute(!1);break;case"<=":this._semantic(e.left),this._semantic(e.right),this._smallerThenExecute(!0);break;case"==":this._semantic(e.left),this._semantic(e.right),this._equalExecute(!1);break;case"!=":this._semantic(e.left),this._semantic(e.right),this._equalExecute(!0);break;case"!":this._semantic(e.right),this._notExpression();break;case"|":this._semantic(e.left),this._semantic(e.right),this._orExecute();break;case"=":this._semantic(e.left),this._semantic(e.right),this._assignExecute();break;case"var":let i=null===(t=e.variable)||void 0===t?void 0:t.name;if(null==i)throw o.error("no variable name error"),new Error("no variable name error");i in this.variables||(this.variables[i]=void 0),this.stack.push({type:"var",value:void 0,variable:e.variable});break;case"string":let n=this._convertVariableInStr(e.value);this.stack.push({type:"string",value:{type:"string",value:n},variable:void 0});break;case"number":let s=e.value;this.stack.push({type:"number",value:{type:"number",value:s},variable:void 0});break;case"json":let a=this._convertVariableInStr(e.value);var r=this._strToJson(a);this.stack.push({type:"json",value:{type:"json",value:r},variable:void 0})}}_output(e){var t=e.value,r=this._convertVariableInStr(t);console.log(r)}_outputHttpResponse(e,t,r){console.log("%s %s",e,t),console.log(JSON.stringify(r,null,2))}async _webAPIRequest(e){const t=[];if(null!=e.headers)for(var r of e.headers){const e=this._convertVariableInStr(r.value);t.push({key:r.key,value:e})}var i=[];if(null!=e.parameters)for(var n of e.parameters){const e=this._convertVariableInStr(n);i.push(e)}var s=void 0;if(null!=e.body)if("string"==e.body.type){s=this._convertVariableInStr(e.body.value)}else{const t=this._convertVariableInStr(e.body.value),r=JSON.parse(t);s=JSON.stringify(r)}const a=this._convertVariableInStr(e.url),l=await async function(e,t,r,i,n){const s=new Headers;let a="";if(null!=i)for(var l of i)a.length>0&&(a+="&"),a+=l;let h=t;if(a.length>0&&(h=h+"?"+a),null!=r)for(let e of r)s.append(e.key,e.value);try{return await fetch(h,{method:e,headers:s,body:""==n?void 0:n})}catch(e){throw o.error("http request error(%s)",e.toString()),e}}(e.method,a,t,i,s),h={url:l.url,status:l.status,headers:{},bodyType:"string",body:void 0};l.headers.forEach(((e,t)=>{h.headers[t]=e}));if(l.headers.get("content-type").includes("application/json")){const e=await l.json();h.body=e,h.bodyType="json"}else{const e=await l.text();h.body=e,h.bodyType="string"}if(this._outputHttpResponse(e.method,a,h),null!=e.bind){const t=e.bind;this.variables[t]={type:"json",value:h}}}async _ifExecute(e){if(null==e.cond)return;this._semantic(e.cond);const t=this.stack.pop();"number"==t.type&&0!=t.value.value&&await this._run(e.syntaxList,!1)}async _whileExecute(e){if(null!=e.cond)for(;;){this._semantic(e.cond);const t=this.stack.pop();if("number"!=t.type||0==t.value.value)break;await this._run(e.syntaxList,!1)}}async _sleepExecute(e){if(null==e.cond)return;this._semantic(e.cond);const t=this.stack.pop();if("number"==t.type&&null!=t.value){let e=t.value.value;e>0&&await i.setTimeout(e)}}async _run(e,t){for(let r of e)switch(t&&(this.stack.length=0),r.type){case"output":this._output(r);break;case"http":await this._webAPIRequest(r);break;case"if":await this._ifExecute(r);break;case"while":await this._whileExecute(r);break;case"sleep":await this._sleepExecute(r);break;default:this._semantic(r)}}async run(e){try{await this._run(e,!0)}catch(e){throw o.error("script stopped (%s)",e.toString()),e}}}const c=`\nVERSION: ${require("../package.json").version}\nUSAGE: hcs [OPTIONS] file parameters...\n\nOPTIONS:\n    -h              display this help.\n`;!function(){const e=s(process.argv.slice(2));if(null!=e.h)return void console.log(c);const t=e._;0===t.length&&(console.error("no input"),console.log(c),process.exit(1));const i=[],n=t[0];for(var a=1;a<t.length;a++)i.push(t[a]);(async function(e,t){if(!r.existsSync(e))return o.error(`file not found: ${e}`),-1;try{const i=r.readFileSync(e,"utf-8"),n=(new l).parse(i),s=new h(t);await s.run(n)}catch(e){return-1}return 0})(n,i).then((e=>{process.exit(e)})).catch((e=>{process.exit(1)}))}();
